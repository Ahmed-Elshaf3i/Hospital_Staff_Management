<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appointment Scheduler Dashboard</title>
<link rel="stylesheet" href="Untitled-1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar">
    <h2>Scheduler</h2>
    <ul>
        <li><a href="#" onclick="showSection('booking', this)" class="active"><i class="fa fa-calendar"></i> Book Appointment</a></li>
        <li><a href="#" onclick="showSection('calendar', this)"><i class="fa fa-calendar-check"></i> Appointment Calendar</a></li>
        <li><a href="#" onclick="showSection('availability', this)"><i class="fa fa-clock"></i> Manage Availability</a></li>
        <li><a href="#" onclick="showSection('checkin', this)"><i class="fa fa-check"></i> Check-In</a></li>
    </ul>
</nav>

<!-- Top Navbar -->
<header class="topbar">
    <div class="logo">Appointment Scheduler</div>
    <div class="user-info">
        <span>Admin</span>
        <button>Logout</button>
    </div>
</header>

<!-- Main Content -->
<main>
    <!-- Booking Section -->
    <section id="booking">
        <header><h1>üìÖ Book Appointment</h1></header>
        <div class="card">
            <form class="form" id="bookingForm">
                <label>Client</label>
                <select id="clientSelect" required>
                    <option value="">Select Client</option>
                </select>

                <label>Provider</label>
                <select id="bookingProvider" required>
                    <option value="">Select Provider</option>
                </select>

                <label>Date</label>
                <input type="date" id="bookingDate" required>

                <label>Start Time</label>
                <input type="time" id="bookingStart" required>

                <button type="submit">Book Appointment</button>
            </form>
        </div>
    </section>

    <!-- Calendar Section -->
    <section id="calendar" style="display:none;">
        <header><h1>üóì Appointment Calendar</h1></header>
        <div class="card calendar" id="calendarContent">
            <p>No appointments yet.</p>
        </div>
    </section>

    <!-- Availability Section -->
    <section id="availability" style="display:none;">
        <header><h1>‚è∞ Manage Availability</h1></header>
        <div class="card">
            <form class="form" id="availabilityForm">
                <label>Provider</label>
                <select id="availabilityProvider" required>
                    <option value="">Select Provider</option>
                </select>

                <label>Date</label>
                <input type="date" id="availabilityDate" required>

                <label>Start Time</label>
                <input type="time" id="availabilityStart" required>

                <label>End Time</label>
                <input type="time" id="availabilityEnd" required>

                <label>Available</label>
                <select id="availabilityStatus">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>

                <button type="submit">Set Availability</button>
            </form>
        </div>
    </section>

    <!-- Check-In Section -->
    <section id="checkin" style="display:none;">
        <header><h1>‚úÖ Check-In</h1></header>
        <div class="card">
            <form class="form" id="checkinForm">
                <label>Client</label>
                <select id="checkinClient" required>
                    <option value="">Select Client</option>
                </select>

                <label>Appointment ID</label>
                <input type="text" id="checkinAppointment" placeholder="Enter appointment ID" required>

                <label>Status</label>
                <select id="checkinStatus">
                    <option value="checked_in">Checked-In</option>
                    <option value="late">Late</option>
                    <option value="no_show">No Show</option>
                </select>

                <button type="submit">Check In</button>
            </form>
        </div>
    </section>
</main>

<script>
// ------------------ Section Switch ------------------
function showSection(id, el){
    document.querySelectorAll('main section').forEach(sec => sec.style.display='none');
    document.getElementById(id).style.display='block';
    document.querySelectorAll('.sidebar ul li a').forEach(a => a.classList.remove('active'));
    el.classList.add('active');
}

// ------------------ Fetch Users for Selects ------------------
async function loadUsers(){
    try {
        const res = await fetch('getuser.php');
        const data = await res.json();

        const providerSelects = [document.getElementById('bookingProvider'), document.getElementById('availabilityProvider')];
        const clientSelects = [document.getElementById('clientSelect'), document.getElementById('checkinClient')];

        data.forEach(u => {
            if(u.role === 'provider'){
                providerSelects.forEach(sel => {
                    const option = document.createElement('option');
                    option.value = u.user_id;
                    option.textContent = u.full_name;
                    sel.appendChild(option);
                });
            }
            if(u.role === 'client'){
                clientSelects.forEach(sel => {
                    const option = document.createElement('option');
                    option.value = u.user_id;
                    option.textContent = u.full_name;
                    sel.appendChild(option);
                });
            }
        });
    } catch(err) {
        alert("Failed to load users: " + err.message);
    }
}
loadUsers();

// ------------------ Booking Form ------------------
document.getElementById('bookingForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const client_id   = document.getElementById('clientSelect').value;
    const provider_id = document.getElementById('bookingProvider').value;
    const start_time  = document.getElementById('bookingDate').value + ' ' + document.getElementById('bookingStart').value;

    if(!client_id || !provider_id || !start_time) return alert("All fields are required");

    // ÿ≠ÿ≥ÿßÿ® end_time = start_time + 1 ÿ≥ÿßÿπÿ©
    const startDT = new Date(start_time);
    const endDT = new Date(startDT.getTime() + 60*60*1000); // +1 ÿ≥ÿßÿπÿ©
    const pad = n => n.toString().padStart(2, '0');
    const formatDT = dt => `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    const end_time = formatDT(endDT);

    const res = await fetch('book.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id, provider_id, start_time, end_time })
    });
    const data = await res.json();
    if(data.success) alert("Appointment booked!");
    else alert(data.message || "Failed to book appointment");
    updateCalendar();
    this.reset();
});

// ------------------ Availability Form ------------------
document.getElementById('availabilityForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const provider = document.getElementById('availabilityProvider').value;
    const date = document.getElementById('availabilityDate').value;
    const start = document.getElementById('availabilityStart').value;
    const end = document.getElementById('availabilityEnd').value;
    const isAvailable = document.getElementById('availabilityStatus').value;

    if(!provider || !date || !start || !end) return alert("All fields are required");

    const res = await fetch('availability.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider, date, start, end, isAvailable })
    });
    const data = await res.json();
    if(data.success) alert("Availability updated!");
    else alert(data.message || "Failed to update availability");
    this.reset();
});

// ------------------ Check-In Form ------------------
document.getElementById('checkinForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const client_id      = document.getElementById('checkinClient').value;
    const appointment_id = document.getElementById('checkinAppointment').value;
    const status         = document.getElementById('checkinStatus').value;

    if(!client_id || !appointment_id) return alert("All fields are required");

    const res = await fetch('checkin.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id, appointment_id, status })
    });
    const data = await res.json();
    if(data.success) alert("Check-In recorded!");
    else alert(data.message || "Failed to record check-in");
    updateCalendar();
    this.reset();
});

// ------------------ Update Calendar ------------------
async function updateCalendar(){
    try {
        const res = await fetch('get.php');
        const data = await res.json();
        const container = document.getElementById('calendarContent');

        if(!data.length){
            container.innerHTML = "<p>No appointments yet.</p>";
            return;
        }

        let html = "<table>";
        html += "<tr><th>ID</th><th>Client</th><th>Provider</th><th>Start</th><th>End</th><th>Status</th></tr>";
        data.forEach(a => {
            html += `<tr>
                        <td>${a.appointment_id}</td>
                        <td>${a.client_name}</td>
                        <td>${a.provider_name}</td>
                        <td>${a.start_time}</td>
                        <td>${a.end_time}</td>
                        <td>${a.status}</td>
                     </tr>`;
        });
        html += "</table>";

        container.innerHTML = html;
    } catch(err) {
        alert("Failed to load appointments: " + err.message);
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿßŸÑŸÜÿØÿ± ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
updateCalendar();
</script>

</body>
</html>
